<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Historik - EV Smart Charger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        .card { background-color: #1e1e1e; border-radius: 12px; border: 1px solid #333; box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-bottom: 20px; color: #fff; }
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 12px 10px; z-index: 1000; }
        .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-item.active { color: #4dabf7; }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
        .content { padding-bottom: 90px; max-width: 800px; margin: 0 auto; }
        .table { color: #e0e0e0; border-color: #333; }
        .table thead { background-color: #252525; }
        .text-spot { color: #4dabf7; }
        .text-grid { color: #ffd43b; }
        .text-energy { color: #69db7c; }
    </style>
</head>
<body>

<div class="container mt-4 content">
    <h5 class="mb-4 text-center text-uppercase fw-bold" style="color: #888; letter-spacing: 1px;">ðŸ“Š Laddhistorik</h5>

    <div class="card p-3">
        <div class="table-responsive">
            <table class="table table-dark table-hover small">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Bil</th>
                        <th class="text-end">kWh</th>
                        <th class="text-end">Fart</th>
                        <th class="text-end">El (kr)</th>
                        <th class="text-end">NÃ¤t (kr)</th>
                        <th class="text-end">Totalt</th>
                        <th class="text-end">Effekt.</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr><td colspan="7" class="text-center py-4">HÃ¤mtar historik...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<nav class="nav-bottom">
    <a href="/" class="nav-item">
        <i class="bi bi-lightning-charge-fill"></i>
        Ladda
    </a>
    <a href="/planning" class="nav-item">
        <i class="bi bi-calendar-check-fill"></i>
        Plan
    </a>
    <a href="/history" class="nav-item active">
        <i class="bi bi-clock-history"></i>
        Historik
    </a>
    <a href="/cars" class="nav-item">
        <i class="bi bi-car-front-fill"></i>
        Bilar
    </a>
    <a href="/settings" class="nav-item">
        <i class="bi bi-gear-fill"></i>
        InstÃ¤lln.
    </a>
</nav>

<script>
    function loadHistory() {
        fetch('/api/history')
            .then(res => res.json())
            .then(data => {
                const body = document.getElementById('history-body');
                if (!data.sessions || data.sessions.length === 0) {
                    body.innerHTML = '<tr><td colspan="7" class="text-center">Inga sessioner loggade Ã¤n.</td></tr>';
                    return;
                }

                body.innerHTML = data.sessions.map(s => {
                    const date = new Date(s.start_time).toLocaleDateString('sv-SE');
                    
                    let car = 'OkÃ¤nd';
                    if (s.vehicle_id === 'mercedes_eqv') car = 'EQV';
                    else if (s.vehicle_id === 'nissan_leaf') car = 'Leaf';
                    else if (s.vehicle_id === 'UNKNOWN_GUEST') car = 'GÃ¤st';
                    
                    // Efficiency calculation (kWh per 10 km / mil)
                    let efficiency = '-';
                    if (s.start_odo && s.end_odo && s.end_odo > s.start_odo) {
                        const dist_mil = (s.end_odo - s.start_odo) / 10;
                        if (dist_mil > 0) {
                            efficiency = (s.energy_kwh / dist_mil).toFixed(1) + ' kWh/mil';
                        }
                    }

                    return `
                        <tr>
                            <td>${date}</td>
                            <td><span class="badge bg-secondary">${car}</span></td>
                            <td class="text-end text-energy fw-bold">${s.energy_kwh.toFixed(1)}</td>
                            <td class="text-end small text-muted">${s.avg_power_kw ? s.avg_power_kw.toFixed(1) + ' kW' : '-'}</td>
                            <td class="text-end text-spot">${s.cost_spot.toFixed(2)}</td>
                            <td class="text-end text-grid">${s.cost_grid.toFixed(2)}</td>
                            <td class="text-end fw-bold">${s.cost_sek.toFixed(2)}</td>
                            <td class="text-end small text-muted">${efficiency}</td>
                        </tr>
                    `;
                }).join('');
            });
    }
    loadHistory();
</script>
</body>
</html>
