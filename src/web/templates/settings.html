<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inst√§llningar - EV Smart Charger</title>
    
    <!-- PWA / Mobile App Settings -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EV Charger">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/lightning-charge-fill.svg">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Dark Theme */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        
        /* Cards */
        .card { 
            background-color: #1e1e1e; 
            border-radius: 12px; 
            border: 1px solid #333; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            margin-bottom: 20px; 
            color: #fff;
        }
        
        /* Navigation */
        .nav-bottom {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1e1e1e; 
            border-top: 1px solid #333;
            display: flex; justify-content: space-around; padding: 12px 10px;
            z-index: 1000;
        }
        .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-item.active { color: #4dabf7; }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
        
        .content { padding-bottom: 90px; max_width: 600px; margin: 0 auto; }
        
        input[type=range] { width: 100%; accent-color: #4dabf7; }
        
        /* Form Controls Dark */
        .form-control {
            background-color: #2c2c2c;
            border-color: #444;
            color: #fff;
        }
        .form-control:focus {
            background-color: #2c2c2c;
            color: #fff;
            border-color: #4dabf7;
            box-shadow: 0 0 0 0.25rem rgba(77, 171, 247, 0.25);
        }
        
        /* Colors */
        .text-primary { color: #4dabf7 !important; }
        .text-muted { color: #adb5bd !important; }
        
        .border-bottom { border-color: #333 !important; }
        
        /* Buttons */
        .btn-primary { background-color: #1c7ed6; border: none; }
        .btn-primary:hover { background-color: #1971c2; }
    </style>
</head>
<body>

<div class="container mt-4 content">
    <h5 class="mb-4 text-center text-uppercase fw-bold" style="color: #888; letter-spacing: 1px;">‚öôÔ∏è Inst√§llningar</h5>

    <!-- Charge Targets -->
    <div class="card p-4">
        <h5 class="mb-4">üöó Laddm√•l & Flexibilitet</h5>
        <p class="small text-muted mb-4">
            Systemet v√§ljer ett m√•l mellan <b>Min</b> och <b>Max</b> beroende p√• elpriset kommande dagar.
            <br>‚Ä¢ √Ñr det billigt laddas bilen till <b>Max</b>.
            <br>‚Ä¢ √Ñr det dyrt laddas bilen bara till <b>Min</b>.
        </p>
        
        <!-- Mercedes -->
        <div class="mb-4 border-bottom pb-4">
            <h6 class="fw-bold text-primary">Mercedes EQV</h6>
            
            <div class="mb-3">
                <label class="form-label d-flex justify-content-between small">
                    <span>Min SoC (M√•ste ha)</span>
                    <span id="merc-min-val" class="fw-bold">40%</span>
                </label>
                <input type="range" class="form-range" min="10" max="90" step="5" id="mercedes_min_soc" oninput="updateDualVal('mercedes', 'min', this.value)">
            </div>

            <div class="mb-2">
                <label class="form-label d-flex justify-content-between small">
                    <span>Max SoC (Om billigt)</span>
                    <span id="merc-max-val" class="fw-bold">80%</span>
                </label>
                <input type="range" class="form-range" min="20" max="100" step="5" id="mercedes_max_soc" oninput="updateDualVal('mercedes', 'max', this.value)">
            </div>
        </div>

        <!-- Nissan -->
        <div class="mb-2">
            <h6 class="fw-bold text-primary">Nissan Leaf</h6>
            
            <div class="mb-3">
                <label class="form-label d-flex justify-content-between small">
                    <span>Min SoC (M√•ste ha)</span>
                    <span id="leaf-min-val" class="fw-bold">40%</span>
                </label>
                <input type="range" class="form-range" min="10" max="90" step="5" id="nissan_min_soc" oninput="updateDualVal('nissan', 'min', this.value)">
            </div>

            <div class="mb-2">
                <label class="form-label d-flex justify-content-between small">
                    <span>Max SoC (Om billigt)</span>
                    <span id="leaf-max-val" class="fw-bold">80%</span>
                </label>
                <input type="range" class="form-range" min="20" max="100" step="5" id="nissan_max_soc" oninput="updateDualVal('nissan', 'max', this.value)">
            </div>
        </div>
    </div>
    
    <!-- Departure -->
    <div class="card p-4 text-center">
        <h5 class="mb-3">üïí Avresa</h5>
        <p class="text-muted small">N√§r ska bilarna vara klara?</p>
        <div class="d-flex justify-content-center">
            <select class="form-select form-select-lg text-center fw-bold" id="departure_time" style="max-width: 180px; background-color: #2c2c2c; color: #fff; border-color: #444;">
                <!-- Options populated by JS -->
            </select>
        </div>
    </div>

    <div class="d-grid">
        <button class="btn btn-primary btn-lg" onclick="saveSettings()">Spara √§ndringar</button>
    </div>
    
    <div id="toast" class="toast align-items-center text-white bg-success border-0 position-fixed top-0 start-50 translate-middle-x mt-3" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          Inst√§llningar sparade!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>

</div>

<nav class="nav-bottom">
    <a href="/" class="nav-item">
        <i class="bi bi-lightning-charge-fill"></i>
        Ladda
    </a>
    <a href="/planning" class="nav-item">
        <i class="bi bi-calendar-check-fill"></i>
        Plan
    </a>
    <a href="/history" class="nav-item">
        <i class="bi bi-clock-history"></i>
        Historik
    </a>
    <a href="/cars" class="nav-item">
        <i class="bi bi-car-front-fill"></i>
        Bilar
    </a>
    <a href="/settings" class="nav-item active">
        <i class="bi bi-gear-fill"></i>
        Inst√§lln.
    </a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function updateDualVal(car, type, val) {
        const minId = car === 'mercedes' ? 'mercedes_min_soc' : 'nissan_min_soc';
        const maxId = car === 'mercedes' ? 'mercedes_max_soc' : 'nissan_max_soc';
        const valId = car === 'mercedes' ? (type === 'min' ? 'merc-min-val' : 'merc-max-val') : (type === 'min' ? 'leaf-min-val' : 'leaf-max-val');
        
        const minEl = document.getElementById(minId);
        const maxEl = document.getElementById(maxId);
        
        let minVal = parseInt(minEl.value);
        let maxVal = parseInt(maxEl.value);

        if (type === 'min' && minVal > maxVal) {
            maxEl.value = minVal;
            document.getElementById(valId.replace('min', 'max')).innerText = minVal + '%';
        } else if (type === 'max' && maxVal < minVal) {
            minEl.value = maxVal;
            document.getElementById(valId.replace('max', 'min')).innerText = maxVal + '%';
        }

        document.getElementById(valId).innerText = val + '%';
    }

    // Load Settings
    fetch('/api/settings?t=' + new Date().getTime())
        .then(res => res.json())
        .then(data => {
            const mercMin = data.mercedes_eqv_min_soc || 40;
            const mercMax = data.mercedes_eqv_max_soc || data.mercedes_target || 80;
            
            document.getElementById('mercedes_min_soc').value = mercMin;
            updateDualVal('mercedes', 'min', mercMin);
            document.getElementById('mercedes_max_soc').value = mercMax;
            updateDualVal('mercedes', 'max', mercMax);
            
            const leafMin = data.nissan_leaf_min_soc || 40;
            const leafMax = data.nissan_leaf_max_soc || data.nissan_target || 80;
            
            document.getElementById('nissan_min_soc').value = leafMin;
            updateDualVal('nissan', 'min', leafMin);
            document.getElementById('nissan_max_soc').value = leafMax;
            updateDualVal('nissan', 'max', leafMax);
            
            // Populate Time Dropdown
            const timeSelect = document.getElementById('departure_time');
            timeSelect.innerHTML = '';
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.text = timeStr;
                    timeSelect.appendChild(option);
                }
            }
            
            // Set current value
            timeSelect.value = data.departure_time || "07:00";
        });

    function saveSettings() {
        const data = {
            mercedes_eqv_min_soc: parseInt(document.getElementById('mercedes_min_soc').value),
            mercedes_eqv_max_soc: parseInt(document.getElementById('mercedes_max_soc').value),
            mercedes_target: parseInt(document.getElementById('mercedes_max_soc').value), 
            
            nissan_leaf_min_soc: parseInt(document.getElementById('nissan_min_soc').value),
            nissan_leaf_max_soc: parseInt(document.getElementById('nissan_max_soc').value),
            nissan_target: parseInt(document.getElementById('nissan_max_soc').value),

            departure_time: document.getElementById('departure_time').value
        };

        fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(() => {
            const toast = new bootstrap.Toast(document.getElementById('toast'));
            toast.show();
        });
    }
</script>

</body>
</html>