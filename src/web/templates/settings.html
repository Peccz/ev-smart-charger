<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inst√§llningar - EV Smart Charger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .nav-bottom {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; padding: 10px;
            z-index: 1000;
        }
        .nav-item { text-align: center; color: #6c757d; text-decoration: none; font-size: 12px; }
        .nav-item.active { color: #0d6efd; font-weight: bold; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        .content { padding-bottom: 80px; max-width: 600px; margin: 0 auto; }
        input[type=range] { width: 100%; }
    </style>
</head>
<body>

<div class="container mt-4 content">
    <h4 class="mb-4 fw-bold text-center">‚öôÔ∏è Inst√§llningar</h4>

    <!-- Charge Targets -->
    <div class="card p-4">
        <h5 class="mb-4">üöó Laddm√•l & Flexibilitet</h5>
        <p class="small text-muted mb-4">
            Systemet v√§ljer ett m√•l mellan <b>Min</b> och <b>Max</b> beroende p√• elpriset kommande dagar.
            <br>‚Ä¢ √Ñr det billigt laddas bilen till <b>Max</b>.
            <br>‚Ä¢ √Ñr det dyrt laddas bilen bara till <b>Min</b>.
        </p>
        
        <!-- Mercedes -->
        <div class="mb-4 border-bottom pb-4">
            <h6 class="fw-bold text-primary">Mercedes EQV</h6>
            
            <div class="mb-3">
                <label class="form-label d-flex justify-content-between small">
                    <span>Min SoC (M√•ste ha)</span>
                    <span id="merc-min-val" class="fw-bold">40%</span>
                </label>
                <input type="range" class="form-range" min="10" max="90" step="5" id="mercedes_min_soc" oninput="updateDualVal('mercedes', 'min', this.value)">
            </div>

            <div class="mb-2">
                <label class="form-label d-flex justify-content-between small">
                    <span>Max SoC (Om billigt)</span>
                    <span id="merc-max-val" class="fw-bold">80%</span>
                </label>
                <input type="range" class="form-range" min="20" max="100" step="5" id="mercedes_max_soc" oninput="updateDualVal('mercedes', 'max', this.value)">
            </div>
        </div>

        <!-- Nissan -->
        <div class="mb-2">
            <h6 class="fw-bold text-primary">Nissan Leaf</h6>
            
            <div class="mb-3">
                <label class="form-label d-flex justify-content-between small">
                    <span>Min SoC (M√•ste ha)</span>
                    <span id="leaf-min-val" class="fw-bold">40%</span>
                </label>
                <input type="range" class="form-range" min="10" max="90" step="5" id="nissan_min_soc" oninput="updateDualVal('nissan', 'min', this.value)">
            </div>

            <div class="mb-2">
                <label class="form-label d-flex justify-content-between small">
                    <span>Max SoC (Om billigt)</span>
                    <span id="leaf-max-val" class="fw-bold">80%</span>
                </label>
                <input type="range" class="form-range" min="20" max="100" step="5" id="nissan_max_soc" oninput="updateDualVal('nissan', 'max', this.value)">
            </div>
        </div>
    </div>
    
    <!-- Departure -->
    <div class="card p-4">
        <h5 class="mb-3">üïí Avresa</h5>
        <p class="text-muted small">Bilarna ska vara klara senast denna tid.</p>
        <input type="time" class="form-control form-control-lg" id="departure_time">
    </div>

    <!-- Home Assistant Config -->
    <div class="card p-4">
        <h5 class="mb-3">üè† Home Assistant Integration (Mercedes)</h5>
        <div class="mb-2">
            <label class="small text-muted">Home Assistant URL (inkl. port)</label>
            <input type="text" class="form-control" id="ha_url" value="http://100.100.118.62:8123">
        </div>
        <div class="mb-2">
            <label class="small text-muted">Long-Lived Access Token</label>
            <input type="password" class="form-control" id="ha_token">
        </div>
        <div class="mb-3">
            <label class="small text-muted">Mercedes EQV SoC Entitets ID</label>
            <input type="text" class="form-control" id="ha_merc_soc_entity_id" placeholder="sensor.mercedes_eqv_battery_level">
        </div>
        <div class="mb-3">
            <label class="small text-muted">Mercedes EQV Status/Plugged ID (Valfritt)</label>
            <input type="text" class="form-control" id="ha_merc_plugged_entity_id" placeholder="sensor.urg48t_charging_status">
            <div class="form-text" style="font-size: 0.8em;">Anv√§nds f√∂r att se om kabeln √§r i (t.ex. sensor.urg48t_charging_status).</div>
        </div>
        <div class="small text-muted mt-2">H√§mtar Mercedes batteristatus fr√•n HA.</div>
    </div>

    <!-- Nissan Connect Config -->
    <div class="card p-4">
        <h5 class="mb-3">üöó Nissan Connect</h5>
        <div class="mb-2">
            <label class="small text-muted">Anv√§ndarnamn (e-post)</label>
            <input type="email" class="form-control" id="nissan_username">
        </div>
        <div class="mb-3">
            <label class="small text-muted">L√∂senord</label>
            <input type="password" class="form-control" id="nissan_password">
        </div>
        <div class="mb-3">
            <label class="small text-muted">VIN (Valfritt)</label>
            <input type="text" class="form-control" id="nissan_vin" placeholder="T.ex. JN1... (kan autouppt√§ckas)">
        </div>
        <div class="small text-muted mt-2">Anv√§nder Nissan Connect API f√∂r batteristatus.</div>
    </div>
    
    <div class="d-grid">
        <button class="btn btn-primary btn-lg" onclick="saveSettings()">Spara √§ndringar</button>
    </div>
    
    <div id="toast" class="toast align-items-center text-white bg-success border-0 position-fixed top-0 start-50 translate-middle-x mt-3" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          Inst√§llningar sparade!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>

</div>

<nav class="nav-bottom">
    <a href="/" class="nav-item">
        <i class="bi bi-lightning-charge-fill"></i>
        Ladda
    </a>
    <a href="/planning" class="nav-item">
        <i class="bi bi-calendar-check-fill"></i>
        Plan
    </a>
    <a href="/settings" class="nav-item active">
        <i class="bi bi-gear-fill"></i>
        Inst√§llningar
    </a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function updateDualVal(car, type, val) {
        // Constraint logic: Min cannot be > Max, Max cannot be < Min
        const minId = car === 'mercedes' ? 'mercedes_min_soc' : 'nissan_min_soc';
        const maxId = car === 'mercedes' ? 'mercedes_max_soc' : 'nissan_max_soc';
        const valId = car === 'mercedes' ? (type === 'min' ? 'merc-min-val' : 'merc-max-val') : (type === 'min' ? 'leaf-min-val' : 'leaf-max-val');
        
        const minEl = document.getElementById(minId);
        const maxEl = document.getElementById(maxId);
        
        let minVal = parseInt(minEl.value);
        let maxVal = parseInt(maxEl.value);

        if (type === 'min' && minVal > maxVal) {
            maxEl.value = minVal;
            document.getElementById(valId.replace('min', 'max')).innerText = minVal + '%';
        } else if (type === 'max' && maxVal < minVal) {
            minEl.value = maxVal;
            document.getElementById(valId.replace('max', 'min')).innerText = maxVal + '%';
        }

        document.getElementById(valId).innerText = val + '%';
    }

    // Load Settings
    fetch('/api/settings?t=' + new Date().getTime())
        .then(res => res.json())
        .then(data => {
            // Mercedes Defaults (ID: mercedes_eqv)
            const mercMin = data.mercedes_eqv_min_soc || 40;
            const mercMax = data.mercedes_eqv_max_soc || data.mercedes_target || 80;
            
            document.getElementById('mercedes_min_soc').value = mercMin;
            updateDualVal('mercedes', 'min', mercMin);
            document.getElementById('mercedes_max_soc').value = mercMax;
            updateDualVal('mercedes', 'max', mercMax);
            
            // Nissan Defaults (ID: nissan_leaf)
            const leafMin = data.nissan_leaf_min_soc || 40;
            const leafMax = data.nissan_leaf_max_soc || data.nissan_target || 80;
            
            document.getElementById('nissan_min_soc').value = leafMin;
            updateDualVal('nissan', 'min', leafMin);
            document.getElementById('nissan_max_soc').value = leafMax;
            updateDualVal('nissan', 'max', leafMax);
            
            document.getElementById('departure_time').value = data.departure_time || "07:00";
            
            document.getElementById('ha_url').value = data.ha_url || "http://100.100.118.62:8123";
            document.getElementById('ha_token').value = data.ha_token || "";
            document.getElementById('ha_merc_soc_entity_id').value = data.ha_merc_soc_entity_id || "";
            document.getElementById('ha_merc_plugged_entity_id').value = data.ha_merc_plugged_entity_id || "";

            document.getElementById('nissan_username').value = data.nissan_username || "";
            document.getElementById('nissan_password').value = data.nissan_password || "";
            document.getElementById('nissan_vin').value = data.nissan_vin || "";
        });

    function saveSettings() {
        const data = {
            mercedes_eqv_min_soc: parseInt(document.getElementById('mercedes_min_soc').value),
            mercedes_eqv_max_soc: parseInt(document.getElementById('mercedes_max_soc').value),
            // Keep old target for backward compatibility or fallback, set to Max. Also update key.
            mercedes_target: parseInt(document.getElementById('mercedes_max_soc').value), 
            
            nissan_leaf_min_soc: parseInt(document.getElementById('nissan_min_soc').value),
            nissan_leaf_max_soc: parseInt(document.getElementById('nissan_max_soc').value),
            // Keep old target for backward compatibility
            nissan_target: parseInt(document.getElementById('nissan_max_soc').value),

            departure_time: document.getElementById('departure_time').value,
            ha_url: document.getElementById('ha_url').value,
            ha_token: document.getElementById('ha_token').value,
            ha_merc_soc_entity_id: document.getElementById('ha_merc_soc_entity_id').value,
            ha_merc_plugged_entity_id: document.getElementById('ha_merc_plugged_entity_id').value,
            nissan_username: document.getElementById('nissan_username').value,
            nissan_password: document.getElementById('nissan_password').value,
            nissan_vin: document.getElementById('nissan_vin').value
        };

        fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(() => {
            const toast = new bootstrap.Toast(document.getElementById('toast'));
            toast.show();
        });
    }
</script>

</body>
</html>
