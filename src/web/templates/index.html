<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EV Smart Charger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .soc-circle {
            width: 100px; height: 100px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; color: white;
            margin: 0 auto 15px auto;
            border: 5px solid rgba(255,255,255,0.3);
            cursor: pointer; /* Indicating clickable */
        }
        .nav-bottom {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; padding: 10px;
            z-index: 1000;
        }
        .nav-item { text-align: center; color: #6c757d; text-decoration: none; font-size: 12px; }
        .nav-item.active { color: #0d6efd; font-weight: bold; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        .content { padding-bottom: 80px; max_width: 600px; margin: 0 auto; }
        
        .status-bar {
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: center;
            color: white;
            box_shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-icon { font-size: 32px; display: block; margin-bottom: 5px; }
        
        /* Manual SoC Slider hidden by default */
        .manual-soc-container {
            display: none;
            background: #f1f3f5;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container mt-4 content">
    <h4 class="mb-4 fw-bold text-center">‚ö° Smart Laddning</h4>

    <!-- Top Status Bar -->
    <div id="system-status" class="status-bar bg-secondary">
        <div class="spinner-border spinner-border-sm"></div> Laddar status...
    </div>

    <div id="car-container"></div>

</div>

<nav class="nav-bottom">
    <a href="/" class="nav-item active">
        <i class="bi bi-lightning-charge-fill"></i>
        Ladda
    </a>
    <a href="/planning" class="nav-item">
        <i class="bi bi-calendar-check-fill"></i>
        Plan
    </a>
    <a href="/cars" class="nav-item">
        <i class="bi bi-car-front-fill"></i>
        Bilar
    </a>
    <a href="/settings" class="nav-item">
        <i class="bi bi-gear-fill"></i>
        Inst√§llningar
    </a>
</nav>

<script>
    function getStatus() {
        fetch('/api/status?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                renderSystemStatus(data);
                renderCars(data.cars);
            });
    }

    // Refresh immediately when switching back to this tab
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') {
            getStatus();
        }
    });
    window.addEventListener("focus", getStatus);

    function renderSystemStatus(data) {
        const bar = document.getElementById('system-status');
        const cars = Object.values(data.cars);
        
        // Find issues
        const urgentCar = cars.find(c => c.needs_plugging);
        const priorityCar = cars.find(c => c.is_priority);
        const chargingCar = cars.find(c => c.action === 'CHARGE' && c.plugged_in);
        
        let bg = 'success';
        let icon = 'bi-check-circle-fill';
        let text = 'Systemet √§r i fas.';
        let subtext = 'Alla bilar redo / fulladdade.';

        if (urgentCar) {
            bg = 'danger';
            icon = 'bi-exclamation-triangle-fill';
            text = `Koppla in ${urgentCar.name}!`;
            subtext = urgentCar.swap_msg ? urgentCar.swap_msg : "Bilen beh√∂ver laddas f√∂r att n√• m√•let.";
        } else if (chargingCar) {
            bg = 'primary';
            icon = 'bi-lightning-charge-fill';
            text = `Laddar ${chargingCar.name}...`;
            subtext = `Smart laddning p√•g√•r.`;
        } else if (priorityCar && priorityCar.plugged_in) {
            bg = 'info'; // Light blue
            icon = 'bi-clock-history';
            text = `${priorityCar.name} v√§ntar.`;
            subtext = priorityCar.start_time_text || "Laddningen startar senare ikv√§ll.";
        } else {
            // Idle / Done
            bg = 'success';
            icon = 'bi-check-circle-fill';
            text = "Alla bilar redo / fulladdade.";
            subtext = "";
        }

        bar.className = `status-bar bg-${bg}`;
        bar.innerHTML = `
            <i class="bi ${icon} status-icon"></i>
            <div class="fw-bold fs-5">${text}</div>
            <div class="small opacity-75">${subtext}</div>
        `;
    }

    function renderCars(carsMap) {
        const container = document.getElementById('car-container');
        // Avoid redrawing if user is interacting with a slider
        if (document.activeElement.type === 'range') return;

        let html = '';

        Object.values(carsMap).forEach(car => {
            let color = 'success';
            if (car.soc < car.target) color = 'warning';
            if (car.soc < 20) color = 'danger';
            
            let statusText = car.reason;
            let badge = car.plugged_in ? '<span class="badge bg-success">Inkopplad</span>' : '<span class="badge bg-secondary">Ej ansluten</span>';
            
            if (car.override && car.override.action === 'CHARGE') {
                statusText = "üî• TV√ÖNGSLADDAR";
                color = 'danger'; 
            }
            if (statusText.includes("Waiting")) statusText = "V√§ntar p√• billigare el...";
            if (statusText.includes("Current hour")) statusText = "Laddar smart (Billigt!)";
            if (statusText.includes("Vehicle not plugged")) statusText = "Redo att laddas.";
            if (car.start_time_text) statusText = `<span class="fw-bold text-dark">${car.start_time_text}</span>`;

            let borderStyle = car.is_priority ? 'border: 2px solid #0d6efd;' : '';

            html += `
                <div class="card p-4" style="${borderStyle}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-bold">${car.name}</h5>
                        ${badge}
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <div class="soc-circle bg-${color} me-4" onclick="toggleManual('${car.id}')" title="Klicka f√∂r att √§ndra %">
                            ${car.soc}%
                        </div>
                        <div>
                            <div class="text-muted small mb-1">
                                M√•l: <strong>${car.target}%</strong>
                                <span class="ms-1" style="font-size: 0.85em; opacity: 0.7;">(${car.min_soc || 40}-${car.max_soc || 80}%)</span>
                            </div>
                            <div class="small text-primary">${statusText}</div>
                            <div class="small text-muted mt-1" style="font-size: 10px;">(Klicka p√• cirkeln f√∂r att √§ndra %)</div>
                        </div>
                    </div>
                    
                    <!-- Manual SoC Slider -->
                    <div id="manual-${car.id}" class="manual-soc-container">
                        <label class="form-label small fw-bold">Justera batteriniv√• manuellt:</label>
                        <div class="d-flex align-items-center">
                            <input type="range" class="form-range me-2" min="0" max="100" step="1" value="${car.manual_soc || car.soc}" oninput="document.getElementById('manual-soc-val-${car.id}').innerText = this.value + '%'; setManualSoc('${car.id}', this.value);">
                            <span class="fw-bold" id="manual-soc-val-${car.id}">${car.manual_soc || car.soc}%</span>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        ${car.override && car.override.action === 'CHARGE' ? 
                            `<button class="btn btn-sm btn-outline-danger" onclick="setOverride('${car.id}', 'AUTO')">Avbryt (√Öterg√• till Auto)</button>` :
                            `<button class="btn btn-sm btn-primary" onclick="setOverride('${car.id}', 'CHARGE')">‚ö° Ladda Nu</button>`
                        }
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function toggleManual(id) {
        const el = document.getElementById(`manual-${id}`);
        if (el.style.display === 'block') {
            el.style.display = 'none';
        } else {
            el.style.display = 'block';
            // Ensure the value display is updated if opened
            const rangeInput = document.querySelector(`#manual-${id} input[type="range"]`);
            if (rangeInput) {
                document.getElementById(`manual-soc-val-${id}`).innerText = rangeInput.value + '%';
            }
        }
    }

    function setManualSoc(id, val) {
        fetch('/api/manual_soc', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ vehicle_id: id, soc: val })
        }).then(() => {
            // GetStatus will re-render and close the slider unless we prevent it
            // For now, let's keep it simple and just re-render fully.
            getStatus();
        });
    }

    function setOverride(id, action) {
        fetch('/api/override', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ vehicle_id: id, action: action })
        }).then(() => getStatus());
    }

    getStatus();
    setInterval(getStatus, 5000);
</script>

</body>
</html>
