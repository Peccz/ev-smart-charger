<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EV Smart Charger</title>
    
    <!-- PWA / Mobile App Settings -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EV Charger">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/lightning-charge-fill.svg">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Nibe-inspired Dark Theme */
        body { 
            background-color: #121212; 
            color: #e0e0e0; 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        /* Cards */
        .card { 
            background-color: #1e1e1e; 
            border-radius: 12px; 
            border: 1px solid #333; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            margin-bottom: 20px; 
            color: #fff;
        }
        .card h5 { font-weight: 600; letter-spacing: 0.5px; }
        
        /* Accents */
        .text-primary { color: #4dabf7 !important; }
        .text-success { color: #69db7c !important; }
        .text-warning { color: #ffd43b !important; }
        .text-danger { color: #ff8787 !important; }
        .text-muted { color: #adb5bd !important; }

        /* SoC Circle */
        .soc-circle {
            width: 110px; height: 110px; border-radius: 50%; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            font-size: 28px; font-weight: 700; color: white;
            margin: 0 auto 15px auto;
            border: 6px solid rgba(255,255,255,0.1);
            background: #2c2c2c; /* Fallback */
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .soc-circle:active { transform: scale(0.95); }
        .soc-circle.charging {
            border-color: #69db7c;
            box-shadow: 0 0 20px rgba(105, 219, 124, 0.4);
        }
        
        /* Bottom Nav */
        .nav-bottom {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1e1e1e; 
            border-top: 1px solid #333;
            display: flex; justify-content: space-around; padding: 12px 10px;
            z-index: 1000;
        }
        .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-item.active { color: #4dabf7; }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
        
        .content { padding-bottom: 90px; max_width: 600px; margin: 0 auto; }
        
        /* Status Bar */
        .status-bar {
            background-color: #252525;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: center;
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            min-height: 80px;
        }
        .status-icon { font-size: 36px; margin-right: 15px; }
        .status-text { text-align: left; }
        .status-title { font-weight: 700; font-size: 1.1rem; line-height: 1.2; }
        .status-subtitle { font-size: 0.85rem; opacity: 0.7; margin-top: 2px; }

        /* Status colors */
        .status-ok { border-left: 5px solid #69db7c; }
        .status-warn { border-left: 5px solid #ffd43b; }
        .status-alert { border-left: 5px solid #ff8787; }
        .status-info { border-left: 5px solid #4dabf7; }

        /* Manual Slider */
        .manual-soc-container {
            display: none;
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #333;
        }
        
        /* Buttons */
        .btn-primary { background-color: #1c7ed6; border: none; }
        .btn-primary:hover { background-color: #1971c2; }
        .btn-outline-danger { color: #ff8787; border-color: #ff8787; }
        .btn-outline-danger:hover { background-color: #ff8787; color: white; }
        
        /* Badge */
        .badge { font-weight: 500; padding: 6px 10px; border-radius: 6px; }
        .bg-success { background-color: rgba(105, 219, 124, 0.2) !important; color: #69db7c; border: 1px solid #69db7c; }
        .bg-secondary { background-color: rgba(173, 181, 189, 0.2) !important; color: #adb5bd; border: 1px solid #6c757d; }
        
        /* Range Input */
        input[type=range] { accent-color: #4dabf7; }
    </style>
</head>
<body>

<div class="container mt-4 content">
    <h5 class="mb-4 text-center text-uppercase fw-bold" style="color: #888; letter-spacing: 1px;">Smart Laddning</h5>

    <!-- System Status -->
    <div id="system-status" class="status-bar status-info">
        <div class="spinner-border spinner-border-sm text-secondary"></div> 
        <span class="ms-3 text-muted">Laddar status...</span>
    </div>

    <!-- Departure Time Display -->
    <div class="card p-3 mb-4 text-center border-0" style="background: linear-gradient(145deg, #1e1e1e, #252525); border: 1px solid #333!important; position: relative;">
        <div id="save-indicator" class="position-absolute top-0 end-0 p-2 small text-success fw-bold" style="display: none; font-size: 9px;"><i class="bi bi-cloud-check"></i> SPARAT</div>
        <div class="text-muted small text-uppercase fw-bold mb-2" style="letter-spacing: 1px; font-size: 10px;">Planerad Avresa</div>
        <div class="d-flex justify-content-center">
            <select class="form-select form-select-lg text-center fw-bold text-primary" id="departure_time" 
                style="max-width: 150px; background: transparent; border: none; font-size: 2rem; padding: 0; cursor: pointer; text-shadow: 0 0 10px rgba(77, 171, 247, 0.3);"
                onchange="saveDeparture(this.value)">
                <!-- Options populated by JS -->
            </select>
        </div>
    </div>

    <div id="car-container"></div>

</div>

<nav class="nav-bottom">
    <a href="/" class="nav-item active">
        <i class="bi bi-lightning-charge-fill"></i>
        Ladda
    </a>
    <a href="/planning" class="nav-item">
        <i class="bi bi-calendar-check-fill"></i>
        Plan
    </a>
    <a href="/history" class="nav-item">
        <i class="bi bi-clock-history"></i>
        Historik
    </a>
    <a href="/cars" class="nav-item">
        <i class="bi bi-car-front-fill"></i>
        Bilar
    </a>
    <a href="/settings" class="nav-item">
        <i class="bi bi-gear-fill"></i>
        Inställn.
    </a>
</nav>

<script>
    let isSaving = false;

    function getStatus() {
        if (isSaving) return;
        fetch('/api/status?t=' + new Date().getTime())
            .then(response => response.json())
            .then(data => {
                renderSystemStatus(data);
                renderCars(data.cars);
                
                const timeSelect = document.getElementById('departure_time');
                if (timeSelect.options.length === 0) {
                    populateDepartureOptions(data.system.departure || "07:00");
                } else if (data.system.departure && timeSelect.value !== data.system.departure) {
                    timeSelect.value = data.system.departure;
                }
            });
    }

    function populateDepartureOptions(currentValue) {
        const timeSelect = document.getElementById('departure_time');
        timeSelect.innerHTML = '';
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 30) {
                const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                const option = document.createElement('option');
                option.value = timeStr;
                option.text = timeStr;
                timeSelect.appendChild(option);
            }
        }
        timeSelect.value = currentValue;
    }

    function saveDeparture(newTime) {
        isSaving = true;
        const indicator = document.getElementById('save-indicator');
        const select = document.getElementById('departure_time');
        
        select.style.opacity = '0.5';
        
        fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ departure_time: newTime })
        }).then(() => {
            select.style.opacity = '1';
            indicator.style.display = 'block';
            setTimeout(() => { 
                indicator.style.display = 'none';
                isSaving = false;
            }, 2000);
        }).catch(err => {
            isSaving = false;
            select.style.opacity = '1';
            alert("Kunde inte spara: " + err);
        });
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') getStatus();
    });
    window.addEventListener("focus", getStatus);

    function renderSystemStatus(data) {
        const bar = document.getElementById('system-status');
        const cars = Object.values(data.cars);
        
        const sortedCars = cars.sort((a, b) => (b.urgency_score || 0) - (a.urgency_score || 0));
        const priorityCar = sortedCars[0];
        
        let statusType = 'ok';
        let icon = 'bi-check-circle-fill';
        let text = 'Systemet i fas';
        let subtext = 'Inga åtgärder krävs just nu.';
        let iconColor = '#69db7c';

        if (priorityCar && priorityCar.urgency_score > 0 && !priorityCar.plugged_in) {
            statusType = 'alert';
            icon = 'bi-plug-fill';
            iconColor = '#ff8787';
            text = `Anslut ${priorityCar.name}!`;
            subtext = priorityCar.swap_msg || "Bilen behöver laddas för att nå målet.";
        } else if (cars.some(c => c.action === 'CHARGE' && c.plugged_in)) {
            const chargingCar = cars.find(c => c.action === 'CHARGE' && c.plugged_in);
            statusType = 'info';
            icon = 'bi-lightning-charge-fill';
            iconColor = '#4dabf7';
            text = `Laddar ${chargingCar.name}`;
            subtext = `${chargingCar.soc}% ➔ ${chargingCar.target}% (Smart)`;
        } else if (priorityCar && priorityCar.plugged_in && priorityCar.start_time_text) {
            statusType = 'warn';
            icon = 'bi-clock-history';
            iconColor = '#ffd43b';
            text = `${priorityCar.name} väntar`;
            subtext = priorityCar.start_time_text;
        }

        bar.className = `status-bar status-${statusType}`;
        bar.innerHTML = `
            <i class="bi ${icon} status-icon" style="color: ${iconColor};"></i>
            <div class="status-text">
                <div class="status-title">${text}</div>
                <div class="status-subtitle">${subtext}</div>
            </div>
        `;
    }

    function renderCars(carsMap) {
        const container = document.getElementById('car-container');
        if (document.activeElement.type === 'range') return;

        let html = '';

        Object.values(carsMap).forEach(car => {
            let socColor = '#69db7c';
            if (car.soc < car.target) socColor = '#ffd43b';
            if (car.soc < 20) socColor = '#ff8787';
            
            let statusText = car.reason;
            let badgeClass = car.plugged_in ? 'bg-success' : 'bg-secondary';
            let badgeText = car.plugged_in ? 'INKOPPLAD' : 'EJ ANSLUTEN';
            
            if (statusText.includes("Waiting")) statusText = "Väntar på lägre pris";
            if (statusText.includes("Current hour")) statusText = "Laddar (Lågt pris)";
            if (statusText.includes("Vehicle not plugged")) statusText = "Redo att anslutas";
            if (car.start_time_text) statusText = car.start_time_text;

            let borderStyle = car.is_priority ? 'border-color: #4dabf7;' : '';
            let chargingClass = (car.action === 'CHARGE' && car.plugged_in) ? 'charging' : '';

            html += `
                <div class="card p-4" style="${borderStyle}">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">${car.name}</h5>
                        <span class="badge ${badgeClass}" style="font-size: 10px;">${badgeText}</span>
                    </div>
                    
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="text-center" style="flex: 1;">
                            <div class="soc-circle ${chargingClass}" onclick="toggleManual('${car.id}')" style="color: ${socColor};">
                                ${car.soc}<small style="font-size: 14px;">%</small>
                            </div>
                        </div>
                        
                        <div style="flex: 1.2; padding-left: 10px;">
                            <div class="mb-2">
                                <span class="d-block text-muted" style="font-size: 11px; text-transform: uppercase;">MÅLNIVÅ</span>
                                <span class="fs-5 fw-bold">${car.target}%</span>
                                <span class="text-muted small">(${car.min_soc}-${car.max_soc}%)</span>
                            </div>
                            <div>
                                <span class="d-block text-muted" style="font-size: 11px; text-transform: uppercase;">STATUS</span>
                                <span class="text-info small fw-bold">${statusText}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="manual-${car.id}" class="manual-soc-container">
                        <label class="form-label small text-muted text-uppercase mb-2">Manuell Batterinivå</label>
                        <div class="d-flex align-items-center">
                            <input type="range" class="form-range me-3" min="0" max="100" step="1" value="${car.manual_soc || car.soc}" 
                                oninput="document.getElementById('manual-soc-val-${car.id}').innerText = this.value + '%'; setManualSoc('${car.id}', this.value);">
                            <span class="fw-bold fs-5" id="manual-soc-val-${car.id}" style="min-width: 45px;">${car.manual_soc || car.soc}%</span>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function toggleManual(id) {
        const el = document.getElementById(`manual-${id}`);
        if (el.style.display === 'block') {
            el.style.display = 'none';
        } else {
            el.style.display = 'block';
            const rangeInput = document.querySelector(`#manual-${id} input[type="range"]`);
            if (rangeInput) {
                document.getElementById(`manual-soc-val-${id}`).innerText = rangeInput.value + '%';
            }
        }
    }

    function setManualSoc(id, val) {
        fetch('/api/manual_soc', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ vehicle_id: id, soc: val })
        }).then(() => getStatus());
    }

    getStatus();
    setInterval(getStatus, 5000);
</script>

</body>
</html>