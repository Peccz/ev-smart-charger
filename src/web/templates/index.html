<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EV Smart Charger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .soc-circle {
            width: 100px; height: 100px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; color: white;
            margin: 0 auto 15px auto;
            border: 5px solid rgba(255,255,255,0.3);
        }
        .nav-bottom {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; padding: 10px;
            z-index: 1000;
        }
        .nav-item { text-align: center; color: #6c757d; text-decoration: none; font-size: 12px; }
        .nav-item.active { color: #0d6efd; font-weight: bold; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        .content { padding-bottom: 80px; max-width: 600px; margin: 0 auto; }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
            100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
        }
        .urgent-alert { animation: pulse-red 2s infinite; border: 2px solid #dc3545; }
        .priority-glow { border: 2px solid #0d6efd; }
    </style>
</head>
<body>

<div class="container mt-4 content">
    <h4 class="mb-4 fw-bold text-center">‚ö° Smart Laddning</h4>

    <div id="car-container">
        <div class="text-center p-5"><div class="spinner-border text-primary"></div></div>
    </div>

</div>

<nav class="nav-bottom">
    <a href="/" class="nav-item active">
        <i class="bi bi-lightning-charge-fill"></i>
        Ladda
    </a>
    <a href="/settings" class="nav-item">
        <i class="bi bi-gear-fill"></i>
        Inst√§llningar
    </a>
</nav>

<script>
    function getStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('car-container');
                let html = '';

                Object.values(data.cars).forEach(car => {
                    // Color logic
                    let color = 'success';
                    if (car.soc < car.target) color = 'warning';
                    if (car.soc < 20) color = 'danger';
                    
                    let statusText = car.reason;
                    let badge = car.plugged_in ? '<span class="badge bg-success">Inkopplad</span>' : '<span class="badge bg-secondary">Ej ansluten</span>';
                    
                    let cardClass = "card p-4";
                    let alertHtml = "";

                    // URGENCY & SWAP LOGIC
                    if (car.needs_plugging) {
                        cardClass += " urgent-alert";
                        let title = "KOPPLA IN NU!";
                        let msg = car.urgency_msg;
                        
                        if (car.swap_msg) {
                            title = "BYT BIL!";
                            msg = `1. Koppla ur den andra bilen<br>2. Koppla in denna!<br><small>${car.swap_msg}</small>`;
                        }
                        
                        alertHtml = `
                            <div class="alert alert-danger text-center fw-bold mt-3">
                                <i class="bi bi-exclamation-triangle-fill"></i> ${title}<br>
                                <div class="fw-normal mt-1">${msg}</div>
                            </div>
                        `;
                    } else if (car.is_priority && car.plugged_in) {
                        cardClass += " priority-glow";
                        alertHtml = `<div class="badge bg-primary w-100 mt-2">PRIORITERAD BIL</div>`;
                    }

                    if (car.override && car.override.action === 'CHARGE') {
                        statusText = "üî• TV√ÖNGSLADDAR";
                        color = 'danger'; 
                    }
                    
                    if (statusText.includes("Waiting for cheaper")) statusText = "V√§ntar p√• billigare el...";
                    if (statusText.includes("Current hour")) statusText = "Laddar smart (Billigt!)";

                    html += `
                        <div class="${cardClass}">
                            <h5 class="text-center mb-3 fw-bold">${car.name}</h5>
                            <div class="soc-circle bg-${color}">
                                ${car.soc}%
                            </div>
                            <div class="text-center mb-3">
                                ${badge} <br>
                                <small class="text-muted">M√•l: ${car.target}%</small>
                                <div class="mt-2 small text-primary fst-italic">${statusText}</div>
                            </div>
                            
                            ${alertHtml}
                            
                            <div class="d-grid gap-2 mt-3">
                                ${car.override ? 
                                    `<button class="btn btn-outline-secondary" onclick="setOverride('${car.id}', 'AUTO')">√Öterg√• till Auto</button>` :
                                    `<button class="btn btn-primary" onclick="setOverride('${car.id}', 'CHARGE')">‚ö° Ladda Nu (1h)</button>`
                                }
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
    }

    function setOverride(id, action) {
        fetch('/api/override', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ vehicle_id: id, action: action })
        }).then(() => getStatus());
    }

    getStatus();
    setInterval(getStatus, 5000);
</script>

</body>
</html>
